I"™<hr />
<p>layout: post
title: åŒå‘é“¾è¡¨æ€»ç»“
date: 2014-08-14 22:41
â€”</p>

<p><img src="http://www.ashliu.com:8080/uploads/460220146388-1_e.jpg" alt="" /></p>

<p>å›¾æ–‡æ— å…³ï¼Œå¤šå¹´å‰ä¹°çš„ä¸€æœ¬ä¹¦ï¼Œç°åœ¨å”¯ä¸€çš„ä½œç”¨å°±æ˜¯ç»™æˆ‘è€çˆ¸åšæ•å¤´äº†ã€‚<br />
æœ€è¿‘åœ¨é›¶æ•£çš„è¯»äº›æºç ï¼Œå¤ªä¹…ä¸åŠ¨è„‘ç»çš„ç¼˜æ•…ï¼Œçœ‹çš„åƒåŠ›ä¸”ç¼“æ…¢ï¼Œä½†è¿˜æ˜¯æœ‰äº›æ”¶è·ï¼Œè¿™ä¸ªé“¾è¡¨çš„ä½¿ç”¨æ–¹å¼å°±å…¶ä¸­ä¹‹ä¸€ï¼Œä¹‹å‰éƒ½æ˜¯çœ‹åˆ«äººå®ç°ï¼Œæ‡‚äº†å°±ä¸¢ä¸‹ä¸ç®¡ï¼Œæ²¡æœ‰æ€»ç»“ä¹Ÿå°±æ²¡æœ‰è¿›æ­¥ï¼Œæ‰€ä»¥ã€‚ã€‚ç»†æ€ææ€–ï¼Œèµ¶ç´§è®°å½•ä¸‹ã€‚</p>

<p>åŒå‘é“¾è¡¨å¤§å‹å·¥ç¨‹éƒ½éƒ½ä¼šç”¨åˆ°ï¼Œå¹¶ä¸”éƒ½æ˜¯æ‰¿è½½çš„æ ¸å¿ƒæ•°æ®å’Œæµç¨‹ï¼Œæˆ‘è®°å½•ä¸‹3ç§å¸¸è§çš„å®ç°æ–¹å¼ï¼š
###åˆ†ç¦»å‹æ–¹å¼
ä¸ªäººçš„å«æ³•ï¼ŒåŸå› æ˜¯é“¾è¡¨ä¸å…¶ä»–æ•°æ®æ˜¯åˆ†ç¦»å®ç°çš„ï¼Œè§ä»£ç </p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>typedef struct listNode {
	// å‰é©±èŠ‚ç‚¹
	struct listNode *prev;
	// åç»§èŠ‚ç‚¹
	struct listNode *next;
	// å€¼
	void *value;
} listNode;

typedef struct list {
	// è¡¨å¤´æŒ‡é’ˆ
	listNode *head;
	// è¡¨å°¾æŒ‡é’ˆ
	listNode *tail;
	// èŠ‚ç‚¹æ•°é‡
	unsigned long len;
	// å¤åˆ¶å‡½æ•°
	void *(*dup)(void *ptr);
	// é‡Šæ”¾å‡½æ•°
	void (*free)(void *ptr);
	// æ¯”å¯¹å‡½æ•°
	int (*match)(void *ptr, void *key);
} list;
</code></pre></div></div>

<p>è¿™æ®µcodeæ¥è‡ªäºredisï¼Œä¸å¾—ä¸è¯´redisçš„æ•°æ®ç»“æ„å®ç°ä¹‹è§„èŒƒï¼Œè®©äººå¤§èµå•Šï¼<br />
è¿™ç§æ–¹å¼çš„ç‰¹ç‚¹æ˜¯é“¾è¡¨çš„å®ç°ç‹¬ç«‹äºç”¨æˆ·è‡ªå·±çš„ç»“æ„ï¼Œç¨‹åºé‡Œé¢ç›´æ¥ä½¿ç”¨çš„å‡æ˜¯listæˆ–è€…listNodeç»“æ„ï¼Œç”¨æˆ·è‡ªå·±çš„æ•°æ®ç»“æ„éƒ½éšè—åœ¨void *é‡Œé¢ï¼Œä¸åŒç±»å‹çš„é“¾è¡¨æŒ‡å‘ä¸åŒçš„ç”¨æˆ·æ•°æ®ç»“æ„å³å¯ã€‚<br />
é“¾è¡¨çš„æ“ä½œå°±æ˜¯æ ‡å‡†çš„å®ç°æ–¹å¼ï¼Œæ•°æ®ç»“æ„çš„ä¹¦é‡Œé¢éƒ½æœ‰ï¼Œredisçš„å®ç°å½“ç„¶ä¹Ÿæ˜¯ç¾å¦‚ç”»ã€‚(å¼ºçƒˆæ¨èè¯»ä¸€è¯»redis source codeï¼Œå¯ä»¥å‚è€ƒ<a href="https://github.com/huangz1990">é»„å¥å®å›çš„github</a>ï¼Œé‡Œé¢æœ‰æ³¨é‡Šç‰ˆæœ¬çš„ã€‚)</p>

<p>###åµŒå…¥å‹A
libeventçš„å®ç°æ–¹å¼ï¼Œæˆ‘æ˜¯è§‰å¾—æœ‰ç‚¹èŠ±å“¨ï¼Œä½†æ•ˆæœå¾ˆä¸é”™å“Ÿï¼Œdefineç”¨çš„å¿«èµ¶ä¸Štemplateäº†ã€‚</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>#define TAILQ_HEAD(name, type)				\
struct name {								\
	struct type *tqh_first;	/* first element */\
	struct type **tqh_last;	/* addr of last next element */\
}

#define TAILQ_HEAD_INITIALIZER(head)		\
	{ NULL, &amp;(head).tqh_first }

#define TAILQ_ENTRY(type)				\
struct {								\
	struct type *tqe_next;	/* next element */\
	struct type **tqe_prev;	/* address of previous next element *\
}

/* 
 * tail queue access methods 
 */
#define	TAILQ_FIRST(head)		((head)-&gt;tqh_first)
#define	TAILQ_END(head)			NULL
#define	TAILQ_NEXT(elm, field)		((elm)-&gt;field.tqe_next)
#define TAILQ_LAST(head, headname)			\
	(*(((struct headname *)((head)-&gt;tqh_last))-&gt;tqh_last))
/* XXX */
#define TAILQ_PREV(elm, headname, field)	\
	(*(((struct headname *)((elm)-&gt;field.tqe_prev))-&gt;tqh_last))
#define	TAILQ_EMPTY(head)					\
	(TAILQ_FIRST(head) == TAILQ_END(head))

#define TAILQ_FOREACH(var, head, field)	\
	for((var) = TAILQ_FIRST(head);			\
	    (var) != TAILQ_END(head);			\
	    (var) = TAILQ_NEXT(var, field))

#define TAILQ_FOREACH_REVERSE(var, head, field, headname)\
	for((var) = TAILQ_LAST(head, headname);\
	    (var) != TAILQ_END(head);			\
	    (var) = TAILQ_PREV(var, headname, field))

/*
 * Tail queue functions.
 */
#define	TAILQ_INIT(head) do {				\
	(head)-&gt;tqh_first = NULL;				\
	(head)-&gt;tqh_last = &amp;(head)-&gt;tqh_first;	\
} while (0)

#define TAILQ_INSERT_HEAD(head, elm, field) do {\
	if (((elm)-&gt;field.tqe_next = (head)-&gt;tqh_first) != NULL)\
		(head)-&gt;tqh_first-&gt;field.tqe_prev =\
		    &amp;(elm)-&gt;field.tqe_next;			\
	else								\
		(head)-&gt;tqh_last = &amp;(elm)-&gt;field.tqe_next;\
	(head)-&gt;tqh_first = (elm);				\
	(elm)-&gt;field.tqe_prev = &amp;(head)-&gt;tqh_first;\
} while (0)

#define TAILQ_INSERT_TAIL(head, elm, field) do {\
	(elm)-&gt;field.tqe_next = NULL;			\
	(elm)-&gt;field.tqe_prev = (head)-&gt;tqh_last;\
	*(head)-&gt;tqh_last = (elm);				\
	(head)-&gt;tqh_last = &amp;(elm)-&gt;field.tqe_next;\
} while (0)

#define TAILQ_INSERT_AFTER(head, listelm, elm, field) do {\
	if (((elm)-&gt;field.tqe_next = (listelm)-&gt;field.tqe_next) != NULL)\
		(elm)-&gt;field.tqe_next-&gt;field.tqe_prev =\
		    &amp;(elm)-&gt;field.tqe_next;			\
	else								\
		(head)-&gt;tqh_last = &amp;(elm)-&gt;field.tqe_next;\
	(listelm)-&gt;field.tqe_next = (elm);		\
	(elm)-&gt;field.tqe_prev = &amp;(listelm)-&gt;field.tqe_next;\
} while (0)

#define	TAILQ_INSERT_BEFORE(listelm, elm, field) do {\
	(elm)-&gt;field.tqe_prev = (listelm)-&gt;field.tqe_prev;\
	(elm)-&gt;field.tqe_next = (listelm);		\
	*(listelm)-&gt;field.tqe_prev = (elm);	\
	(listelm)-&gt;field.tqe_prev = &amp;(elm)-&gt;field.tqe_next;\
} while (0)

#define TAILQ_REMOVE(head, elm, field) do {\
	if (((elm)-&gt;field.tqe_next) != NULL)	\
		(elm)-&gt;field.tqe_next-&gt;field.tqe_prev =\
		    (elm)-&gt;field.tqe_prev;		\
	else								\
		(head)-&gt;tqh_last = (elm)-&gt;field.tqe_prev;\
	*(elm)-&gt;field.tqe_prev = (elm)-&gt;field.tqe_next;\
} while (0)

#define TAILQ_REPLACE(head, elm, elm2, field) do {\
	if (((elm2)-&gt;field.tqe_next = (elm)-&gt;field.tqe_next) != NULL)\
		(elm2)-&gt;field.tqe_next-&gt;field.tqe_prev =\
		    &amp;(elm2)-&gt;field.tqe_next;		\
	else								\
		(head)-&gt;tqh_last = &amp;(elm2)-&gt;field.tqe_next;\
	(elm2)-&gt;field.tqe_prev = (elm)-&gt;field.tqe_prev;\
	*(elm2)-&gt;field.tqe_prev = (elm2);		\
} while (0)
</code></pre></div></div>

<p>è¿™ç§å®ç°çš„ç‰¹ç‚¹æ˜¯é“¾è¡¨çš„å®ç°åµŒå…¥åˆ°äº†ç”¨æˆ·æ•°æ®ä¸­ï¼Œç»„æˆä¸€ä¸ªæ•´ä½“çš„ç»“æ„ï¼Œé“¾è¡¨ä¼šæŒ‡å‘è¿™æ•´ä¸ªç»“æ„ä½“ï¼Œç„¶åå·§å¦™çš„é€šè¿‡äºŒçº§æŒ‡é’ˆé“¾æ¥èµ·æ¥ã€‚æˆ‘åœ¨çº¸ä¸Šç”»äº†ä¸‹ç®—æ³•å®ç°ï¼Œå‘ç°æˆ‘åˆé‡æ–°æŒæ¡äº†C pointerã€‚ã€‚
###åµŒå…¥å‹B
è¿™ç§ç±»å‹æ‰æ˜¯æˆ‘æœ€å…ˆäº†è§£çš„å®ç°æ–¹å¼ï¼Œä¹Ÿæ˜¯linuxå†…æ ¸çš„é“¾è¡¨å®ç°æ–¹å¼ï¼Œæœ‰ç‚¹åƒæ–¹æ¡ˆ1å’Œæ–¹æ¡ˆ2çš„ç»¼åˆä½“ï¼šé“¾è¡¨ç»“æ„å®šä¹‰ä¸æ–¹æ¡ˆ1ä¸€æ ·ï¼Œä½†æ˜¯ç»“æ„åµŒå…¥äº†ç”¨æˆ·çš„æ•°æ®ç»“æ„ï¼Œä½†å®ƒä¸æ˜¯ä½¿ç”¨defineæ¥ç›´æ¥è·å–ç”¨æˆ·æ•°æ®ç»“æ„ï¼Œè€Œä¸”é€šè¿‡è®¡ç®—listNodeåœ¨ç”¨æˆ·æ•°æ®ç”¨çš„åç§»é‡ï¼Œä»è€Œé—´æ¥çš„å¾—åˆ°ç”¨æˆ·æ•°æ®æŒ‡é’ˆã€‚</p>

<p>###æ€»ç»“
åµŒå…¥å‹çš„éƒ½æœ‰ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯åªèƒ½é“¾æ¥ç»Ÿä¸€ç±»å‹çš„æ•°æ®(æ–¹æ¡ˆBç¡®å®å¯ä»¥é“¾æ¥ä¸åŒçš„ç»“æ„ï¼Œä½†æ˜¯è¿™æ ·ç”¨ä¼šä¸ä¼šå¤ªå¥‡æ€ªäº†ï¼Ÿ)ï¼Œä½†æ˜¯å¯¹äºè§„åˆ’å¥½çš„ç³»ç»Ÿï¼Œè¿™å¹¶ä¸æ˜¯é—®é¢˜ã€‚æ€»ä½“æ¥è¯´éƒ½å·®ä¸å¤šï¼Œæ²¡æœ‰å¥½åä¹‹åˆ†ï¼Œåªçœ‹ä¸ªäººå–œå¥½äº†ã€‚</p>

:ET